#include "effects/custom_gru9.h"

// Static member definitions
// Hidden state in DTCMRAM (zero-wait-state)
DTCMRAM_DATA float CustomGRU9::h_[9] = {};

// Weights in DTCMRAM (zero-wait-state, ~1.4KB).
// DTCMRAM_DATA places in .dtcmram_bss (NOLOAD), so struct is zero-initialized
// and populated at runtime via loadWeights(). This is already the case.
DTCMRAM_DATA CustomGRU9Weights CustomGRU9::w_ = {};

// ============================================================================
// Tanh lookup table: 513 entries covering [-5.0, 5.0]
// Stored in DTCMRAM for zero-wait-state reads during forward pass.
// 513 entries × 4 bytes = 2052 bytes.
// ============================================================================
DTCMRAM_CONST const float CustomGRU9::kTanhTable[513] = {
    -0.999909204f, -0.999905588f, -0.999901827f, -0.999897916f, -0.999893850f, -0.999889622f, -0.999885225f, -0.999880653f,
    -0.999875899f, -0.999870956f, -0.999865816f, -0.999860471f, -0.999854913f, -0.999849134f, -0.999843124f, -0.999836876f,
    -0.999830378f, -0.999823622f, -0.999816596f, -0.999809291f, -0.999801695f, -0.999793796f, -0.999785582f, -0.999777042f,
    -0.999768161f, -0.999758927f, -0.999749325f, -0.999739341f, -0.999728958f, -0.999718163f, -0.999706937f, -0.999695265f,
    -0.999683128f, -0.999670507f, -0.999657384f, -0.999643738f, -0.999629549f, -0.999614794f, -0.999599452f, -0.999583500f,
    -0.999566912f, -0.999549664f, -0.999531728f, -0.999513079f, -0.999493687f, -0.999473523f, -0.999452557f, -0.999430755f,
    -0.999408086f, -0.999384514f, -0.999360004f, -0.999334517f, -0.999308017f, -0.999280461f, -0.999251809f, -0.999222016f,
    -0.999191037f, -0.999158825f, -0.999125331f, -0.999090504f, -0.999054291f, -0.999016637f, -0.998977484f, -0.998936773f,
    -0.998894443f, -0.998850428f, -0.998804661f, -0.998757074f, -0.998707593f, -0.998656144f, -0.998602649f, -0.998547025f,
    -0.998489189f, -0.998429052f, -0.998366524f, -0.998301509f, -0.998233908f, -0.998163620f, -0.998090537f, -0.998014548f,
    -0.997935538f, -0.997853387f, -0.997767971f, -0.997679161f, -0.997586821f, -0.997490811f, -0.997390987f, -0.997287196f,
    -0.997179283f, -0.997067083f, -0.996950427f, -0.996829139f, -0.996703034f, -0.996571923f, -0.996435607f, -0.996293881f,
    -0.996146531f, -0.995993333f, -0.995834058f, -0.995668466f, -0.995496305f, -0.995317319f, -0.995131236f, -0.994937777f,
    -0.994736652f, -0.994527558f, -0.994310181f, -0.994084194f, -0.993849260f, -0.993605026f, -0.993351126f, -0.993087181f,
    -0.992812795f, -0.992527559f, -0.992231047f, -0.991922817f, -0.991602409f, -0.991269348f, -0.990923137f, -0.990563261f,
    -0.990189189f, -0.989800363f, -0.989396210f, -0.988976132f, -0.988539507f, -0.988085692f, -0.987614020f, -0.987123795f,
    -0.986614298f, -0.986084782f, -0.985534472f, -0.984962564f, -0.984368222f, -0.983750582f, -0.983108746f, -0.982441782f,
    -0.981748725f, -0.981028574f, -0.980280289f, -0.979502796f, -0.978694978f, -0.977855680f, -0.976983702f, -0.976077804f,
    -0.975136698f, -0.974159054f, -0.973143491f, -0.972088579f, -0.970992841f, -0.969854743f, -0.968672703f, -0.967445078f,
    -0.966170173f, -0.964846233f, -0.963471443f, -0.962043927f, -0.960561744f, -0.959022891f, -0.957425296f, -0.955766822f,
    -0.954045260f, -0.952258330f, -0.950403680f, -0.948478882f, -0.946481434f, -0.944408755f, -0.942258186f, -0.940026988f,
    -0.937712339f, -0.935311335f, -0.932820989f, -0.930238226f, -0.927559888f, -0.924782729f, -0.921903415f, -0.918918523f,
    -0.915824544f, -0.912617879f, -0.909294839f, -0.905851648f, -0.902284443f, -0.898589270f, -0.894762093f, -0.890798788f,
    -0.886695149f, -0.882446888f, -0.878049638f, -0.873498956f, -0.868790325f, -0.863919159f, -0.858880808f, -0.853670557f,
    -0.848283640f, -0.842715238f, -0.836960488f, -0.831014492f, -0.824872321f, -0.818529025f, -0.811979641f, -0.805219203f,
    -0.798242755f, -0.791045354f, -0.783622091f, -0.775968098f, -0.768078563f, -0.759948744f, -0.751573983f, -0.742949722f,
    -0.734071520f, -0.724935068f, -0.715536210f, -0.705870959f, -0.695935517f, -0.685726293f, -0.675239927f, -0.664473306f,
    -0.653423588f, -0.642088225f, -0.630464979f, -0.618551949f, -0.606347593f, -0.593850744f, -0.581060637f, -0.567976931f,
    -0.554599722f, -0.540929574f, -0.526967527f, -0.512715125f, -0.498174426f, -0.483348023f, -0.468239054f, -0.452851218f,
    -0.437188785f, -0.421256605f, -0.405060115f, -0.388605342f, -0.371898910f, -0.354948034f, -0.337760521f, -0.320344763f,
    -0.302709729f, -0.284864955f, -0.266820527f, -0.248587067f, -0.230175711f, -0.211598088f, -0.192866293f, -0.173992859f,
    -0.154990730f, -0.135873222f, -0.116653989f, -0.097346989f, -0.077966441f, -0.058526787f, -0.039042644f, -0.019528767f,
     0.000000000f,  0.019528767f,  0.039042644f,  0.058526787f,  0.077966441f,  0.097346989f,  0.116653989f,  0.135873222f,
     0.154990730f,  0.173992859f,  0.192866293f,  0.211598088f,  0.230175711f,  0.248587067f,  0.266820527f,  0.284864955f,
     0.302709729f,  0.320344763f,  0.337760521f,  0.354948034f,  0.371898910f,  0.388605342f,  0.405060115f,  0.421256605f,
     0.437188785f,  0.452851218f,  0.468239054f,  0.483348023f,  0.498174426f,  0.512715125f,  0.526967527f,  0.540929574f,
     0.554599722f,  0.567976931f,  0.581060637f,  0.593850744f,  0.606347593f,  0.618551949f,  0.630464979f,  0.642088225f,
     0.653423588f,  0.664473306f,  0.675239927f,  0.685726293f,  0.695935517f,  0.705870959f,  0.715536210f,  0.724935068f,
     0.734071520f,  0.742949722f,  0.751573983f,  0.759948744f,  0.768078563f,  0.775968098f,  0.783622091f,  0.791045354f,
     0.798242755f,  0.805219203f,  0.811979641f,  0.818529025f,  0.824872321f,  0.831014492f,  0.836960488f,  0.842715238f,
     0.848283640f,  0.853670557f,  0.858880808f,  0.863919159f,  0.868790325f,  0.873498956f,  0.878049638f,  0.882446888f,
     0.886695149f,  0.890798788f,  0.894762093f,  0.898589270f,  0.902284443f,  0.905851648f,  0.909294839f,  0.912617879f,
     0.915824544f,  0.918918523f,  0.921903415f,  0.924782729f,  0.927559888f,  0.930238226f,  0.932820989f,  0.935311335f,
     0.937712339f,  0.940026988f,  0.942258186f,  0.944408755f,  0.946481434f,  0.948478882f,  0.950403680f,  0.952258330f,
     0.954045260f,  0.955766822f,  0.957425296f,  0.959022891f,  0.960561744f,  0.962043927f,  0.963471443f,  0.964846233f,
     0.966170173f,  0.967445078f,  0.968672703f,  0.969854743f,  0.970992841f,  0.972088579f,  0.973143491f,  0.974159054f,
     0.975136698f,  0.976077804f,  0.976983702f,  0.977855680f,  0.978694978f,  0.979502796f,  0.980280289f,  0.981028574f,
     0.981748725f,  0.982441782f,  0.983108746f,  0.983750582f,  0.984368222f,  0.984962564f,  0.985534472f,  0.986084782f,
     0.986614298f,  0.987123795f,  0.987614020f,  0.988085692f,  0.988539507f,  0.988976132f,  0.989396210f,  0.989800363f,
     0.990189189f,  0.990563261f,  0.990923137f,  0.991269348f,  0.991602409f,  0.991922817f,  0.992231047f,  0.992527559f,
     0.992812795f,  0.993087181f,  0.993351126f,  0.993605026f,  0.993849260f,  0.994084194f,  0.994310181f,  0.994527558f,
     0.994736652f,  0.994937777f,  0.995131236f,  0.995317319f,  0.995496305f,  0.995668466f,  0.995834058f,  0.995993333f,
     0.996146531f,  0.996293881f,  0.996435607f,  0.996571923f,  0.996703034f,  0.996829139f,  0.996950427f,  0.997067083f,
     0.997179283f,  0.997287196f,  0.997390987f,  0.997490811f,  0.997586821f,  0.997679161f,  0.997767971f,  0.997853387f,
     0.997935538f,  0.998014548f,  0.998090537f,  0.998163620f,  0.998233908f,  0.998301509f,  0.998366524f,  0.998429052f,
     0.998489189f,  0.998547025f,  0.998602649f,  0.998656144f,  0.998707593f,  0.998757074f,  0.998804661f,  0.998850428f,
     0.998894443f,  0.998936773f,  0.998977484f,  0.999016637f,  0.999054291f,  0.999090504f,  0.999125331f,  0.999158825f,
     0.999191037f,  0.999222016f,  0.999251809f,  0.999280461f,  0.999308017f,  0.999334517f,  0.999360004f,  0.999384514f,
     0.999408086f,  0.999430755f,  0.999452557f,  0.999473523f,  0.999493687f,  0.999513079f,  0.999531728f,  0.999549664f,
     0.999566912f,  0.999583500f,  0.999599452f,  0.999614794f,  0.999629549f,  0.999643738f,  0.999657384f,  0.999670507f,
     0.999683128f,  0.999695265f,  0.999706937f,  0.999718163f,  0.999728958f,  0.999739341f,  0.999749325f,  0.999758927f,
     0.999768161f,  0.999777042f,  0.999785582f,  0.999793796f,  0.999801695f,  0.999809291f,  0.999816596f,  0.999823622f,
     0.999830378f,  0.999836876f,  0.999843124f,  0.999849134f,  0.999854913f,  0.999860471f,  0.999865816f,  0.999870956f,
     0.999875899f,  0.999880653f,  0.999885225f,  0.999889622f,  0.999893850f,  0.999897916f,  0.999901827f,  0.999905588f,
     0.999909204f
};

// ============================================================================
// Sigmoid lookup table: 513 entries covering [-10.0, 10.0]
// Stored in DTCMRAM for zero-wait-state reads during forward pass.
// 513 entries × 4 bytes = 2052 bytes.
// ============================================================================
DTCMRAM_CONST const float CustomGRU9::kSigmoidTable[513] = {
    0.000045398f, 0.000047206f, 0.000049087f, 0.000051042f, 0.000053075f, 0.000055189f, 0.000057388f, 0.000059674f,
    0.000062050f, 0.000064522f, 0.000067092f, 0.000069765f, 0.000072544f, 0.000075433f, 0.000078438f, 0.000081562f,
    0.000084811f, 0.000088189f, 0.000091702f, 0.000095355f, 0.000099153f, 0.000103102f, 0.000107209f, 0.000111479f,
    0.000115919f, 0.000120536f, 0.000125338f, 0.000130330f, 0.000135521f, 0.000140919f, 0.000146531f, 0.000152368f,
    0.000158436f, 0.000164747f, 0.000171308f, 0.000178131f, 0.000185226f, 0.000192603f, 0.000200274f, 0.000208250f,
    0.000216544f, 0.000225168f, 0.000234136f, 0.000243460f, 0.000253156f, 0.000263238f, 0.000273722f, 0.000284622f,
    0.000295957f, 0.000307743f, 0.000319998f, 0.000332741f, 0.000345992f, 0.000359769f, 0.000374096f, 0.000388992f,
    0.000404481f, 0.000420587f, 0.000437334f, 0.000454748f, 0.000472854f, 0.000491682f, 0.000511258f, 0.000531613f,
    0.000552779f, 0.000574786f, 0.000597669f, 0.000621463f, 0.000646203f, 0.000671928f, 0.000698676f, 0.000726488f,
    0.000755406f, 0.000785474f, 0.000816738f, 0.000849246f, 0.000883046f, 0.000918190f, 0.000954732f, 0.000992726f,
    0.001032231f, 0.001073306f, 0.001116014f, 0.001160420f, 0.001206590f, 0.001254594f, 0.001304507f, 0.001356402f,
    0.001410358f, 0.001466458f, 0.001524786f, 0.001585431f, 0.001648483f, 0.001714038f, 0.001782196f, 0.001853059f,
    0.001926735f, 0.002003333f, 0.002082971f, 0.002165767f, 0.002251847f, 0.002341341f, 0.002434382f, 0.002531111f,
    0.002631674f, 0.002736221f, 0.002844910f, 0.002957903f, 0.003075370f, 0.003197487f, 0.003324437f, 0.003456410f,
    0.003593603f, 0.003736221f, 0.003884477f, 0.004038592f, 0.004198795f, 0.004365326f, 0.004538432f, 0.004718369f,
    0.004905406f, 0.005099818f, 0.005301895f, 0.005511934f, 0.005730247f, 0.005957154f, 0.006192990f, 0.006438103f,
    0.006692851f, 0.006957609f, 0.007232764f, 0.007518718f, 0.007815889f, 0.008124709f, 0.008445627f, 0.008779109f,
    0.009125637f, 0.009485713f, 0.009859855f, 0.010248602f, 0.010652511f, 0.011072160f, 0.011508149f, 0.011961098f,
    0.012431651f, 0.012920473f, 0.013428255f, 0.013955710f, 0.014503580f, 0.015072628f, 0.015663649f, 0.016277461f,
    0.016914913f, 0.017576883f, 0.018264278f, 0.018978037f, 0.019719128f, 0.020488555f, 0.021287352f, 0.022116589f,
    0.022977370f, 0.023870835f, 0.024798160f, 0.025760559f, 0.026759283f, 0.027795623f, 0.028870907f, 0.029986506f,
    0.031143831f, 0.032344332f, 0.033589506f, 0.034880887f, 0.036220056f, 0.037608636f, 0.039048293f, 0.040540738f,
    0.042087728f, 0.043691061f, 0.045352581f, 0.047074176f, 0.048857779f, 0.050705365f, 0.052618953f, 0.054600606f,
    0.056652425f, 0.058776556f, 0.060975181f, 0.063250522f, 0.065604837f, 0.068040420f, 0.070559596f, 0.073164721f,
    0.075858180f, 0.078642381f, 0.081519756f, 0.084492754f, 0.087563840f, 0.090735488f, 0.094010180f, 0.097390398f,
    0.100878623f, 0.104477323f, 0.108188955f, 0.112015951f, 0.115960718f, 0.120025628f, 0.124213008f, 0.128525139f,
    0.132964240f, 0.137532466f, 0.142231895f, 0.147064520f, 0.152032242f, 0.157136853f, 0.162380037f, 0.167763347f,
    0.173288206f, 0.178955888f, 0.184767511f, 0.190724025f, 0.196826204f, 0.203074628f, 0.209469681f, 0.216011535f,
    0.222700139f, 0.229535213f, 0.236516236f, 0.243642438f, 0.250912787f, 0.258325989f, 0.265880473f, 0.273574391f,
    0.281405607f, 0.289371697f, 0.297469943f, 0.305697329f, 0.314050545f, 0.322525983f, 0.331119740f, 0.339827619f,
    0.348645135f, 0.357567522f, 0.366589736f, 0.375706466f, 0.384912144f, 0.394200956f, 0.403566854f, 0.413003570f,
    0.422504635f, 0.432063389f, 0.441673006f, 0.451326506f, 0.461016779f, 0.470736607f, 0.480478678f, 0.490235617f,
    0.500000000f, 0.509764383f, 0.519521322f, 0.529263393f, 0.538983221f, 0.548673494f, 0.558326994f, 0.567936611f,
    0.577495365f, 0.586996430f, 0.596433146f, 0.605799044f, 0.615087856f, 0.624293534f, 0.633410264f, 0.642432478f,
    0.651354865f, 0.660172381f, 0.668880260f, 0.677474017f, 0.685949455f, 0.694302671f, 0.702530057f, 0.710628303f,
    0.718594393f, 0.726425609f, 0.734119527f, 0.741674011f, 0.749087213f, 0.756357562f, 0.763483764f, 0.770464787f,
    0.777299861f, 0.783988465f, 0.790530319f, 0.796925372f, 0.803173796f, 0.809275975f, 0.815232489f, 0.821044112f,
    0.826711794f, 0.832236653f, 0.837619963f, 0.842863147f, 0.847967758f, 0.852935480f, 0.857768105f, 0.862467534f,
    0.867035760f, 0.871474861f, 0.875786992f, 0.879974372f, 0.884039282f, 0.887984049f, 0.891811045f, 0.895522677f,
    0.899121377f, 0.902609602f, 0.905989820f, 0.909264512f, 0.912436160f, 0.915507246f, 0.918480244f, 0.921357619f,
    0.924141820f, 0.926835279f, 0.929440404f, 0.931959580f, 0.934395163f, 0.936749478f, 0.939024819f, 0.941223444f,
    0.943347575f, 0.945399394f, 0.947381047f, 0.949294635f, 0.951142221f, 0.952925824f, 0.954647419f, 0.956308939f,
    0.957912272f, 0.959459262f, 0.960951707f, 0.962391364f, 0.963779944f, 0.965119113f, 0.966410494f, 0.967655668f,
    0.968856169f, 0.970013494f, 0.971129093f, 0.972204377f, 0.973240717f, 0.974239441f, 0.975201840f, 0.976129165f,
    0.977022630f, 0.977883411f, 0.978712648f, 0.979511445f, 0.980280872f, 0.981021963f, 0.981735722f, 0.982423117f,
    0.983085087f, 0.983722539f, 0.984336351f, 0.984927372f, 0.985496420f, 0.986044290f, 0.986571745f, 0.987079527f,
    0.987568349f, 0.988038902f, 0.988491851f, 0.988927840f, 0.989347489f, 0.989751398f, 0.990140145f, 0.990514287f,
    0.990874363f, 0.991220891f, 0.991554373f, 0.991875291f, 0.992184111f, 0.992481282f, 0.992767236f, 0.993042391f,
    0.993307149f, 0.993561897f, 0.993807010f, 0.994042846f, 0.994269753f, 0.994488066f, 0.994698105f, 0.994900182f,
    0.995094594f, 0.995281631f, 0.995461568f, 0.995634674f, 0.995801205f, 0.995961408f, 0.996115523f, 0.996263779f,
    0.996406397f, 0.996543590f, 0.996675563f, 0.996802513f, 0.996924630f, 0.997042097f, 0.997155090f, 0.997263779f,
    0.997368326f, 0.997468889f, 0.997565618f, 0.997658659f, 0.997748153f, 0.997834233f, 0.997917029f, 0.997996667f,
    0.998073265f, 0.998146941f, 0.998217804f, 0.998285962f, 0.998351517f, 0.998414569f, 0.998475214f, 0.998533542f,
    0.998589642f, 0.998643598f, 0.998695493f, 0.998745406f, 0.998793410f, 0.998839580f, 0.998883986f, 0.998926694f,
    0.998967769f, 0.999007274f, 0.999045268f, 0.999081810f, 0.999116954f, 0.999150754f, 0.999183262f, 0.999214526f,
    0.999244594f, 0.999273512f, 0.999301324f, 0.999328072f, 0.999353797f, 0.999378537f, 0.999402331f, 0.999425214f,
    0.999447221f, 0.999468387f, 0.999488742f, 0.999508318f, 0.999527146f, 0.999545252f, 0.999562666f, 0.999579413f,
    0.999595519f, 0.999611008f, 0.999625904f, 0.999640231f, 0.999654008f, 0.999667259f, 0.999680002f, 0.999692257f,
    0.999704043f, 0.999715378f, 0.999726278f, 0.999736762f, 0.999746844f, 0.999756540f, 0.999765864f, 0.999774832f,
    0.999783456f, 0.999791750f, 0.999799726f, 0.999807397f, 0.999814774f, 0.999821869f, 0.999828692f, 0.999835253f,
    0.999841564f, 0.999847632f, 0.999853469f, 0.999859081f, 0.999864479f, 0.999869670f, 0.999874662f, 0.999879464f,
    0.999884081f, 0.999888521f, 0.999892791f, 0.999896898f, 0.999900847f, 0.999904645f, 0.999908298f, 0.999911811f,
    0.999915189f, 0.999918438f, 0.999921562f, 0.999924567f, 0.999927456f, 0.999930235f, 0.999932908f, 0.999935478f,
    0.999937950f, 0.999940326f, 0.999942612f, 0.999944811f, 0.999946925f, 0.999948958f, 0.999950913f, 0.999952794f,
    0.999954602f
};

/**
 * GRU-9 forward pass — placed in ITCMRAM for zero-wait-state execution.
 *
 * This is in a .cpp file (not header) to ensure:
 * 1. Single definition — no ODR issues across translation units
 * 2. Proper ITCMRAM section placement — noinline prevents LTO from
 *    inlining this into QSPI flash callers
 * 3. The function is called via a branch to ITCMRAM address, executing
 *    entirely from zero-wait-state memory
 *
 * Uses __builtin_fmaf() for multiply-accumulate to guarantee VFMA.F32
 * (single-cycle fused multiply-add on Cortex-M7 FPU).
 */
ITCMRAM_CODE __attribute__((noinline))
float CustomGRU9::forward(float input)
{
    // Phase 1: Matrix-vector products (j-outer for contiguous weight access).
    // Ur[j][0..8] is a contiguous row, so the inner i-loop streams through
    // memory sequentially instead of striding by 9.
    float dr[9] = {0}, dz[9] = {0}, dn[9] = {0};
    for (int j = 0; j < 9; ++j)
    {
        float hj = h_[j];
        const float *ur_row = w_.Ur[j];
        const float *uz_row = w_.Uz[j];
        const float *un_row = w_.Un[j];
        // 3x3 unroll: 9 = 3×3, process 3 outputs per iteration
        // with 3 independent memory streams per gate.
        // __builtin_fmaf guarantees VFMA.F32 (single-cycle on Cortex-M7 FPU).
        for (int i = 0; i < 9; i += 3)
        {
            dr[i]     = __builtin_fmaf(ur_row[i],     hj, dr[i]);
            dr[i + 1] = __builtin_fmaf(ur_row[i + 1], hj, dr[i + 1]);
            dr[i + 2] = __builtin_fmaf(ur_row[i + 2], hj, dr[i + 2]);
            dz[i]     = __builtin_fmaf(uz_row[i],     hj, dz[i]);
            dz[i + 1] = __builtin_fmaf(uz_row[i + 1], hj, dz[i + 1]);
            dz[i + 2] = __builtin_fmaf(uz_row[i + 2], hj, dz[i + 2]);
            dn[i]     = __builtin_fmaf(un_row[i],     hj, dn[i]);
            dn[i + 1] = __builtin_fmaf(un_row[i + 1], hj, dn[i + 1]);
            dn[i + 2] = __builtin_fmaf(un_row[i + 2], hj, dn[i + 2]);
        }
    }

    // Phase 2: Activations + hidden state update + dense output.
    // Uses pre-combined biases (br_c = br + br1, bz_c = bz + bz1)
    // to eliminate 18 adds per sample.
    float output = w_.denseB;
    for (int i = 0; i < 9; ++i)
    {
        float r = fast_sigmoid(__builtin_fmaf(w_.Wr[i], input, dr[i] + w_.br_c[i]));
        float z = fast_sigmoid(__builtin_fmaf(w_.Wz[i], input, dz[i] + w_.bz_c[i]));
        float n = fast_tanh(__builtin_fmaf(w_.Wn[i], input, w_.bn0[i] + r * (dn[i] + w_.bn1[i])));
        h_[i] = __builtin_fmaf(z, h_[i] - n, n); // (1-z)*n + z*h = n + z*(h-n)
        output = __builtin_fmaf(w_.denseW[i], h_[i], output);
    }

    return output;
}
